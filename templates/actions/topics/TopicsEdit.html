<form id="topic-form" method="post" action="?module=topics&action=save{if $topic}&id={$topic.id}{/if}" class="{if empty($topic.status)}draft{else}published{/if}">
    <h1 style="display: none">{if $topic.id}{$topic.title|escape}{else}[`New topic`]{/if}</h1>

    <div class="sidebar right200px">
        <div class="h-topic-options">

            <!-- priority -->
            <div class="block">
                <h6>[`Priority`]</h6>
                <ul id="ul-priority" class="menu-v">
                    <li{if $topic.priority == 1} class="selected"{/if}><a data-value="1" href="javascript:void(0)"><i class="icon16 exclamation-red"></i>[`High`]</a></li>
                    <li{if $topic.priority != 1 && $topic.priority != -1} class="selected"{/if}><a data-value="0" href="javascript:void(0)"><i class="icon16 status-gray-tiny"></i>[`None`]</a></li>
                    <li{if $topic.priority == -1} class="selected"{/if}><a data-value="-1" href="javascript:void(0)"><i class="icon16 status-blue-tiny"></i>[`Low`]</a></li>
                </ul>
                <input id="input-priority" name="topic[priority]" type="hidden" value="{$topic.priority}">
            </div>

            <!-- author -->
            <div class="block">
                <h6>[`Author`]</h6>
                <select>
                    {foreach $users as $u_id => $name}
                        <option {if $topic['contact_id'] == $u_id}selected="selected"{/if} value="{$u_id}">
                            {$name|escape}
                        </option>
                    {/foreach}
                </select>
            </div>

            <!-- meta -->
            <div id="meta-editor" class="block">
                <h6>[`Meta`]</h6>
                <span class="hint no-parameters">[`No meta parameters are defined for this topic.`]</span>
                <span class="small parameters"></span>
                <a id="edit-meta-link" class="small" href="javascript:void(0)">[`Edit meta`]</a>

                <input type="hidden" name="topic[meta_title]" value="{$topic.meta_title|escape}">
                <input type="hidden" name="topic[meta_keywords]" value="{$topic.meta_keywords|escape}">
                <input type="hidden" name="topic[meta_description]" value="{$topic.meta_description|escape}">
            </div>

            {if $topic.id}
                <div class="block">
                    <ul class="menu-v with-icons compact">
                        <li><a href="javascript:void(0)" id="delete-topic-link"><i class="icon16 delete"></i>[`Delete topic`]</a></li>
                    </ul>
                </div>
            {/if}
        </div>
    </div>
    <div class="content right200px">
        <div class="h-stream h-{$hubs[$hub_id].hub_color}">
            <div class="h-header">
            
                {if $topic.id}<a href="#/topic/{$topic.id}/" class="back" style="top: 0;">&larr; [`Back`]</a>{/if}

                <!-- topic type -->
                <ul class="h-topic-type" style="display:none;">
                    {* Some, or even all, of these <li>s get hidden by JS depending on selected hub *}
                    {foreach $types as $type_id => $type}
                        <li{if $topic.type_id == $type_id} class="selected"{/if}>
                            <a data-type="{$type.id}" href="javascript:void(0)">{hubHelper::getGlyph($type.glyph)}{$type.name|default:'[`(no name)`]'|escape}</a>
                        </li>
                    {/foreach}
                </ul>
                <input id="topic-type" type="hidden" name="topic[type_id]" value="{$topic.type_id}">

                <!-- hub -->
                <ul class="menu-h dropdown h-topic-hub">
                    <li>[`Hub`]:</li>
                    <li class="h-topic-hub-dropdown">
                        <a id="topic-hub" class="inline-link" href="javascript:void(0)">
                            <b><i>{$hubs[$hub_id].name|default:'[`(no name)`]'|escape}</i></b>
                            <input type="hidden" name="topic[hub_id]" value="{$hubs[$hub_id].id}">
                            <i class="icon10 darr"></i>
                        </a>
                        <ul class="menu-v with-icons" id="hubs-selector">
                            {foreach $hubs as $h}
                                <li{if $h.id == $hub_id} class="selected"{/if}>
                                    <a href="javascript:void(0)" data-id="{$h.id}" data-color="{$h.hub_color}"><i class="icon16 color h-{$h.hub_color}"></i>{$h.name|default:'[`(no name)`]'|escape}{if !$h.status}<i class="icon10 lock-bw no-overhanging hide-when-published"></i>{/if}</a>
                                </li>
                            {/foreach}
                        </ul>
                    </li>
                </ul>

            </div>

            <div class="h-topic not-padded">
                <div class="block double-padded h-topic-fields">

                    <input type="text" id="h-topic-title" name="topic[title]" class="h-title" value="{$topic.title|escape}" placeholder="[`Topic title`]">

                    <p class="small hidden" id="public-url-editor" style="line-height:27px;">
                        <span class="gray">[`Public URL`]:</span>

                        {strip}
                            <span class="not-editable-url">
                                <a href="" class="preview" target="_blank"></a>
                                &nbsp;
                                <a href="javascript:void(0);" class="small inline-link edit-link">
                                    <i class="icon10 edit" style="margin-top:10px;"></i><b><i>[`edit`]</i></b>
                                </a>
                            </span>

                            <span class="editable-url" style="display:none">
                                <span class="before-topic-url"></span>
                                <input type="text" id="h-topic-url-input" name="topic[url]" value="{$topic.url}">
                                <span class="after-topic-url"></span>
                            </span>

                            <span class="no-frontend" style="display:none">
                                [`Selected hub has no frontend.`]
                            </span>

                        {/strip}
                    </p>

                    <p class="small" id="categories-editor">
                        [`Category`]:
                        <span id="categories-input">{* Updated by JS depending on currently selected hub. *}</span>
                    </p>

                </div>


                <div class="h-topic-editor">

                    <!-- / THIS PART CAN BE CUSTOMIZED/REPLACED BY TOPIC TYPE PLUGINS -->
                    <div class="wa-editor-core-wrapper">

                        <ul class="h-topic-editor-toggle wa-editor-wysiwyg-html-toggle">
                            <li class="selected">
                                <a href="#" class="wysiwyg">WYSIWYG</a>
                            </li>
                            <li>
                                <a href="#" class="html">HTML</a>
                            </li>
                        </ul>

                        <div class="h-topic-editor-wrapper">
                            <textarea id="topic-editor" name="topic[content]">{$topic.content|escape}</textarea>
                            <div id="topic-editor-container"></div>
                        </div>

                        <div class="block double-padded small">
                            [`Tags`]:
                            <span id="h-topic-tags">
                                {foreach $topic.tags as $t}
                                    <span class="tag">{$t|escape}</span>
                                {foreachelse}
                                    <span class="gray">[`No tags assigned`]</span>
                                {/foreach}
                            </span>
                            <input id="h-topic-tags-input" type="text" class="long" value="{foreach $topic.tags as $t}{$t|escape}{if !$t@last},{/if}{/foreach}" name="topic[tags]">
                            <p class="gray">[`Separate tags with comma (,).`]</p>
                            <a href="javascript:void(0)" id="h-topic-tags-edit">[`Edit`]</a>
                        </div>

                    </div>
                    <!-- / THIS PART CAN BE CUSTOMIZED/REPLACED BY TOPIC TYPE PLUGINS -->

                </div>

{* !!! *}
<style>
#topic-form .editing .hide-when-editing,
#topic-form .selecting-subscribers .hide-when-selecting-subscribers
    { display: none; }
.users-to-notify .h-notify-user { margin: 10px 0; }
.users-to-notify .h-notify-user .close { cursor: pointer; margin-left: 1em; }
#subscribers-form-wrapper input { width: 300px; }
</style>


                <div class="block double-padded" id="h-topic-button-bar"><div class="editing">

                    <div class="hide-when-published">
                        <div class="hide-when-selecting-subscribers">

                            {*
                             * Buttons for draft mode, NOT selecting subscribers
                             *}

                            <div class="float-right block half-padded">
                                <ul class="menu-h">
                                    <li><a href="javascript:void(0)" class="inline-link notify-subscribers-toggle"><i class="icon16 lightning"></i><b><i>[`Notify subscribers about this topic`]</i></b></a></li>
                                </ul>
                            </div>

                            <input type="submit" value="[`Publish`]" class="button green button-form-submit" />
                            <input type="submit" name="draft" value="[`Save draft`]" class="button gray draft" />
                            <em class="hint">Ctrl + S</em>


                        </div>
                        <div class="hide-when-editing">

                            {*
                             * Buttons for draft mode, selecting subscribers
                             *}

                            <div class="double-padded block" id="subscribers-form-wrapper" style="padding-top:0">
                                <div class="fields">
                                    <div class="field">
                                        <div class="name">[`To`]</div>
                                        <div class="value" style="position:relative;left:-20px;">
                                            <div class="users-to-notify">{* Updated by JS *}</div>

                                            {* Template for user row *}
                                            <div class="hidden template h-notify-user" data-user-id="">{strip}
                                                <i class="icon16 userpic20 icon-has-userpic" style="background-image: none;"></i>
                                                <i class="icon16 user icon-no-userpic"></i>
                                                <span class="username"></span>
                                                <i class="icon10 close"></i>
                                            {/strip}</div>

                                            {strip}
                                                <i class="icon16 add" style="vertical-align:middle;margin-top:-2px;"></i>
                                                <input type="text" class="subscriber-autocomplete ignore-dirty" placeholder="[`Start typing user or user group name...`]">
                                            {/strip}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <div class="name">[`Message`]</div>
                                        <div class="value"><textarea class="notification-message ignore-dirty" name="notification_message"></textarea></div>
                                    </div>
                                </div>
                                <div class="clear-left"></div>
                            </div>

                            <div class="float-right block half-padded">
                                <ul class="menu-h">
                                    <li><a href="javascript:void(0)" class="inline-link notify-subscribers-toggle"><i class="icon16 lightning"></i><b><i>[`Cancel and back to editing mode`]</i></b></a></li>
                                </ul>
                            </div>

                            <input type="submit" value="[`Publish and notify subscribers`]" class="button green button-form-submit notify-subscribers-submit" />



                        </div>
                    </div>
                    <div class="hide-when-draft">

                        {*
                         * Buttons for published topic
                         *}

                        <div class="float-right block half-padded">
                            <ul class="menu-h">
                                <li>
                                    <a id="h-unpublish-link" href="javascript:void(0)" title="[`Unpublish this topic?`]"><i class="icon10 no-bw"></i>[`Unpublish`]</a>
                                </li>
                            </ul>
                        </div>

                        <input type="submit" value="[`Save`]" class="button green button-form-submit" />
                        <em class="hint">Ctrl + S</em>


                    </div>


                </div></div>

            </div>

            <div class="clear-both"></div>
        </div>

    </div>

</form>



{* Dialog to edit meta data *}
<div id="meta-dialog" class="hidden"><form>
    <div class="dialog-content">
        <h1>[`Meta`]</h1>
        <div class="fields">
            <div class="field">
                <div class="name">
                    <span class="bold">[`Title`]</span>
                    <span class="hint">&lt;title&gt;</span>
                </div>
                <div class="value">
                    <input type="text" name="title">
                </div>
            </div>
            <div class="field">
                <div class="name">[`Meta description`]</div>
                <div class="value"><textarea name="description"></textarea></div>
            </div>
            <div class="field">
                <div class="name">[`Meta keywords`]</div>
                <div class="value"><textarea name="keywords"></textarea></div>
            </div>
        </div>
    </div>
    <div class="dialog-buttons">
        <input type="submit" class="button green" value="[`Save`]">
        [`or`]
        <a href="javascript:void(0)" class="cancel">[`cancel`]</a>
    </div>
</form></div>


{include file="./include.delete_confirm.html" inline}


<script>

var wa_url = "{$wa_url}";
var wa_app = 'hub';

(function() { "use strict";

    // Load JS script, making sure it WILL get cached in non-debug mode
    $.ajax({
          dataType: "script",
          url: "{$wa_app_static_url}js/topics/edit.js?{$wa->version('hub')}",
          cache: true
    }).done(function() {

        $.topics_edit.init({
            topic_id: {ifempty($topic.id, 0)},
            hub_id: {ifempty($topic.hub_id, 0)},
            hub_url_templates: {json_encode($hub_url_templates)},

            types: {json_encode($types)},
            hub_type_ids: {json_encode($hub_type_ids)},

            categories: {json_encode($categories)},
            initial_topic_categories: {json_encode(array_keys($topic.categories))},

            initial_hub_id: {ifempty($topic.hub_id, -1)}
        });

        // Confirmation before leaving this page
        var form_button = $('#topic-form .button-form-submit');
        $.hub.helper.confirmLeave(function() {
            return form_button.hasClass('yellow') && form_button.closest('body').length > 0;
        }, "[`Any changes you made will be lost if you leave.`]", "[`Are you sure?`]");

        $('#h-topic-title').focus();
    });

})();</script>

<script></script>


