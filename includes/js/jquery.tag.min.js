!function(e){e.fn.tag=function(t){var s={separator:",",unique:!0,addOnEnter:!0,style:{list:"taglist",item:"tag",input:"input",remove:"delete"}};t=e.extend(s,t),e(this).each(function(){""!=(separator=e(this).attr("data-separator"))&&(t.separator=separator);var s=function(s){var a=s.replace(/^\s+|\s+$/g,"");if(""!=a){var l=e("<li/>").addClass(t.style.item),r=e("<span/>"),d=e("<span/>").html("[X]"),n=e("<a/>",{tabindex:"-1"}).addClass(t.style.remove).append(d).click(function(){e(this).closest("li").remove(),i()});if(!(t.unique&&e.inArray(a,o)>-1))return o.push(a),r.html(a),l.append(r).append(" ").append(n),l}},a=function(a){if(""!=e(a).val()){var l=s(e(a).val());l?(e(a).closest("li").before(l),e(a).val(e(a).val().replace(t.separator,"")),e(a).width(8).val("").focus()):(e(a).val(""),e(a).width(8)),i(),c.html("")}},i=function(){var s=[];e("li."+t.style.item+" > span",r).each(function(){s.push(e(this).html())}),o=s,e(l).val(s.join(t.separator))},l=e(this);if(l.is(":input")){l.hide();var r=e("<ul/>").addClass(t.style.list).click(function(){e(this).find("input").focus()}),d=e("<input/>",{type:"text"}),n=l.val().split(t.separator),o=[];for(index in n){var h=s(n[index]);r.append(h)}i(),l.after(r);var p=e("<li/>").addClass(t.style.input),c=e("<span/>");c.hide(),p.append(d),d.after(c),r.append(p);var v=function(t){c.html(e(t).val().replace(/\s/g,"&nbsp;"));var s=""==e(t).val()?8:10;e(t).width(c.width()+s)};d.bind("keyup",function(){v(this)}).bind("keydown",function(t){v(this);var s=t.keyCode||t.which;if(""==e(this).val()&&(8==s||46==s)){switch(e(this).width(""!=e(this).val()?c.width()+5:8),s){case 8:e(this).closest("li").prev().is(".ready-to-delete")?(e(".ready-to-delete").removeClass("ready-to-delete"),e(this).closest("li").prev().remove()):(e(".ready-to-delete").removeClass("ready-to-delete"),e(this).closest("li").prev().addClass("ready-to-delete"));break;case 46:e(this).closest("li").next().is(".ready-to-delete")?(e(".ready-to-delete").removeClass("ready-to-delete"),e(this).closest("li").next().remove()):(e(".ready-to-delete").removeClass("ready-to-delete"),e(this).closest("li").next().addClass("ready-to-delete"))}return i(),t.preventDefault(),!1}e(".ready-to-delete").removeClass("ready-to-delete"),""==e(this).val()&&((37==s||38==s)&&(e(this).width(""!=e(this).val()?c.width()+5:8),e(this).closest("li").prev().before(e(this).closest("li")),e(this).focus()),(39==s||40==s)&&(e(this).width(""!=e(this).val()?c.width()+5:8),e(this).closest("li").next().after(e(this).closest("li")),e(this).focus()))}).bind("keypress",function(e){v(this);var s=e.keyCode||e.which;return t.separator==String.fromCharCode(s)||t.separator==s||t.addOnEnter&&13==s?(a(this),e.preventDefault(),!1):void 0}).bind("blur",function(){a(this),e(this).closest("ul").append(e(this).closest("li"))})}})}}(jQuery);